(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{kZhU:function(t,e,i){"use strict";i.r(e),i.d(e,"Ruler",function(){return w}),i.d(e,"init",function(){return n});var e=i("lwsE"),s=i.n(e),e=i("W8MJ"),o=i.n(e),r=300,w=function(){function n(t,e,i){s()(this,n);var o=i.textData;i.logFn;this.textData=void 0===o?{}:o,this.roomConfig=i.roomConfig,this.AppParams=i.AppParams,this.root=new THREE.Group,this.root.name="ruler",this.data=null,this.frameManager=t,this.size=e,this.nearestPosition=null,this.SIZE_UNIT_TYPE=this.roomConfig.SIZE_UNIT_TYPE||"m";this.up=new THREE.PxLine(this.size,new THREE.Color(16777215),new THREE.Vector3,new THREE.Vector3,1),this.up.material.depthTest=!1,this.root.add(this.up),this.left=new THREE.PxLine(this.size,new THREE.Color(16777215),new THREE.Vector3,new THREE.Vector3,1),this.left.material.depthTest=!1,this.root.add(this.left),this.right=new THREE.PxLine(this.size,new THREE.Color(16777215),new THREE.Vector3,new THREE.Vector3,1),this.right.material.depthTest=!1,this.root.add(this.right),this.upLabel=new THREE.CanvasLabel(null,.05,!1,!1),this.upLabel.root.name="upLabel",this.upLabel.root.renderOrder=1,this.upLabel.root.center.set(0,.5),this.root.add(this.upLabel.root),this.leftLabel=new THREE.CanvasLabel(null,.05,!1,!1),this.leftLabel.root.name="leftLabel",this.leftLabel.root.renderOrder=1,this.leftLabel.root.center.set(0,.5),this.root.add(this.leftLabel.root),this.rightLabel=new THREE.CanvasLabel(null,.05,!1,!1),this.rightLabel.root.name="rightLabel",this.rightLabel.root.renderOrder=1,this.rightLabel.root.center.set(0,.5),this.root.add(this.rightLabel.root);i=document.createElement("canvas"),t=i.getContext("2d"),e=16;i.height=i.width=32,t.clearRect(0,0,32,32),t.save(),t.fillStyle="#ffffff",t.arc(e,e,e,0,2*Math.PI),t.fill(),t.restore();i=new THREE.SpriteMaterial({map:new THREE.CanvasTexture(i),color:16777215});this.centerPoint=new THREE.Sprite(i),this.centerPoint.name="centerPoint",this.centerPoint.scale.set(1.5,1.5),this.upPoint=new THREE.Sprite(i),this.upPoint.name="upPoint",this.upPoint.scale.set(1.5,1.5),this.leftPoint=new THREE.Sprite(i),this.leftPoint.name="leftPoint",this.leftPoint.scale.set(1.5,1.5),this.rightPoint=new THREE.Sprite(i),this.rightPoint.name="rightPoint",this.rightPoint.scale.set(1.5,1.5),this.root.add(this.centerPoint),this.root.add(this.upPoint),this.root.add(this.leftPoint),this.root.add(this.rightPoint),this.update=this.update.bind(this)}return o()(n,[{key:"setData",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;this.type=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"room",this.data=t,this.rotationY=e,this.nearestPosition=null,this.root.visible=!1}},{key:"convertWallPoint",value:function(t){if(t=t.Position,"room"===this.type){var e=this.data.Info,i=e.Rotation,o=e.Position,e=new THREE.Vector3(t.x,t.y,-t.z);e.applyAxisAngle(new THREE.Vector3(0,1,0).normalize(),THREE.Math.degToRad(i.x)),e.applyAxisAngle(new THREE.Vector3(0,1,0).normalize(),THREE.Math.degToRad(-i.y)),e.applyAxisAngle(new THREE.Vector3(0,1,0).normalize(),THREE.Math.degToRad(i.z));o=new THREE.Vector3(o.x,o.y,-o.z);return(new THREE.Vector3).addVectors(e,o)}if("spot"===this.type){o=this.data.Position,o=new THREE.Vector3(o.x,o.y,-o.z),t=new THREE.Vector3(t.x,t.y,-t.z);return t.applyAxisAngle(new THREE.Vector3(0,1,0),-THREE.Math.degToRad(this.rotationY)),(new THREE.Vector3).addVectors(o,t)}}},{key:"equalXYZ",value:function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z}},{key:"drawCanvas",value:function(t,e){this.roomConfig;var i=this.AppParams,o=this.SIZE_UNIT_TYPE,n=i.sizeTranslate;e=e.toFixed(1),"ft"===o&&(e=n({size:e}));var s=t.getContext("2d"),r="".concat(this.textData.ruler," ").concat(e," ").concat(o),i=48,n=24,e="".concat(38,"px sans-serif");s.font=e;o=s.measureText(r).width+48;return t.width=o,t.height=i,s.fillStyle="#FFFFFF",s.beginPath(),s.moveTo(n,0),s.lineTo(o-n,0),s.arc(o-n,n,n,-Math.PI/2,Math.PI/2),s.lineTo(n,i),s.arc(n,24,n,Math.PI/2,-Math.PI/2),s.closePath(),s.fill(),s.fillStyle="#000000",s.textAlign="center",s.textBaseline="middle",s.font=e,s.fillText(r,o/2,24),[o,i]}},{key:"onCameraTransform",value:function(n,s,r,o,t){var a,l,h,c,u,i,e,d=this;this.data?(this.root.visible=!0,a=null,l=function(t){var e,i,o;null===a?a=t:(e=(new THREE.Vector3).subVectors(t,n),o=(new THREE.Vector3).subVectors(a,n),i=(new THREE.Vector3).copy(s),(e.y=o.y=i.y=0)===Math.abs(i.x)&&0===Math.abs(i.z)||(e=Math.abs(i.angleTo(e)),i=Math.abs(i.angleTo(o)),o=THREE.Math.degToRad(r/d.size.y*d.size.x/2),e<i&&e<o&&(a=t)))},this.data.Walls.forEach(function(t){var e=t.Start,i=t.End,o=null,t=null,o=d.convertWallPoint(e.Up),t=d.convertWallPoint(e.Down);o.y<t.y&&(t=o),l(t),o=d.convertWallPoint(i.Up),t=d.convertWallPoint(i.Down),o.y<t.y&&(t=o),l(t)}),!(0<this.data.Walls.length)||this.nearestPosition&&this.equalXYZ(this.nearestPosition,a)||(this.nearestPosition=a,this.root.position.copy(this.nearestPosition),u=c=h=null,this.data.Walls.forEach(function(t){var e=t.Start,i=t.End,o=d.convertWallPoint(e.Up),n=d.convertWallPoint(e.Down),t=d.convertWallPoint(i.Up),e=d.convertWallPoint(i.Down),i=function(t){return d.equalXYZ(d.nearestPosition,t)};i(o)&&(h=h||n,c=c||t),i(n)&&(h=h||o,u=u||e),i(t)&&(h=h||e,u=u||o),i(e)&&(h=h||t,c=c||n)}),this.upLabel.root.visible=!1,this.leftLabel.root.visible=!1,this.rightLabel.root.visible=!1,this.centerPoint.visible=!1,this.upPoint.visible=!1,this.leftPoint.visible=!1,this.rightPoint.visible=!1,h?(this.up.visible=!0,this.up.setEnd(h.sub(this.nearestPosition)),this.upLabel.draw(function(t){var e=2<=d.ProtocolVersion?d.data.RoomDetail?.01*d.data.RoomDetail.Info.RoomHeight:.01*d.data.Info.RoomHeight:d.up.end.length()/50;return"0.0"===e.toFixed(1)?(d.up.visible=!1,[0,0]):d.drawCanvas(t,e)},0),this.upLabel.root.position.copy(this.up.end).multiplyScalar(.5),this.upPoint.position.copy(this.up.end)):this.up.visible=!1,c?(this.left.visible=!0,this.left.setEnd(c.sub(this.nearestPosition)),this.leftLabel.draw(function(t){var e=d.left.end.length()/50;return"0.0"===e.toFixed(1)?(d.left.visible=!1,[0,0]):d.drawCanvas(t,e)},0),this.leftLabel.root.position.copy(this.left.end).multiplyScalar(.5),this.leftPoint.position.copy(this.left.end)):this.left.visible=!1,u?(this.right.visible=!0,this.right.setEnd(u.sub(this.nearestPosition)),this.rightLabel.draw(function(t){var e=d.right.end.length()/50;return"0.0"===e.toFixed(1)?(d.right.visible=!1,[0,0]):d.drawCanvas(t,e)},0),this.rightLabel.root.position.copy(this.right.end).multiplyScalar(.5),this.rightPoint.position.copy(this.right.end)):this.right.visible=!1,this.root.scale.set(.001,.001,.001),this.frameManager.remove(this.update),this.frameManager.add(this.update)),i=function(t){var e=d.root.position.clone(),i=(new THREE.Vector3).addVectors(e,t.clone());e.project(o),i.project(o);t=o.aspect;return new THREE.Vector2((e.x-i.x)*t,e.y-i.y).angle()},e=function(t,e){e=i(e);e>Math.PI/2&&e<Math.PI/2*3?(e-=Math.PI,t.root.center.set(0,.5)):t.root.center.set(1,.5),t.setRotation(e)},t&&(this.upLabel.draw(function(t){return d.drawCanvas(t,d.up.end.length()/50)},0),this.leftLabel.draw(function(t){return d.drawCanvas(t,d.left.end.length()/50)},0),this.rightLabel.draw(function(t){return d.drawCanvas(t,d.right.end.length()/50)},0)),e(this.upLabel,this.up.end),e(this.leftLabel,this.left.end),e(this.rightLabel,this.right.end)):this.root.visible=!1}},{key:"update",value:function(t,e){r<=e&&(this.frameManager.remove(this.update),this.centerPoint.visible=!0,this.up.visible&&(this.upLabel.root.visible=!0)&&(this.upPoint.visible=!0),this.left.visible&&(this.leftLabel.root.visible=!0)&&(this.leftPoint.visible=!0),this.right.visible&&(this.rightLabel.root.visible=!0)&&(this.rightPoint.visible=!0),e=r),this.root.scale.set(e/r,e/r,e/r)}},{key:"hide",value:function(t){this.root.visible=!t,this.upLabel.root.visible=!1,this.leftLabel.root.visible=!1,this.rightLabel.root.visible=!1,this.centerPoint.visible=!1,this.upPoint.visible=!1,this.leftPoint.visible=!1,this.rightPoint.visible=!1}}]),n}();function n(e,i){var t=e.frameManager,o=e.renderTool,s=(e.DOMS,e.RENDERS),n=e.listener,r=(e.textData,e.logFn,e.houseData),a=(e.roomConfig,e.AppParams),l=new w(t,o.size,e),h=(a.isPortrait,r.rooms),c=r.roomSpots,u=r.spots,d=r.originData.ProtocolVersion,p=i.open,a=i.type,f=void 0===a?"spot":a,E=null;function v(t){l.root.visible=!0;var e=s.room.camera,i=e.position,o=e.fov,n=new THREE.Vector3;e.getWorldDirection(n),l.onCameraTransform(i,n,o,e,t)}l.ProtocolVersion=d;var b=null;function P(t){for(var e in b=null,c)0===c[e].indexOf(t)&&(b=h[e]);if("spot"===f&&d&&2<=d){for(var i,o=0;o<u.length;o++)u[o].ID===t&&(i=u[o]);b&&i&&i.Walls&&0<i.Walls.length?(l.setData(i,b.Info.Rotation.y,f),v()):l.setData(null,null,f)}else l.setData(b),v()}function g(t){p=0<arguments.length&&void 0!==t?t:p,l.hide(!p);t=s.room.scene;t.remove(l.root),p&&(t.add(l.root),P(E))}var T,m=!1,r=(r.type,{roomRender:{cameraTransform:function(t,e){t.rotation,t.position;p&&!m&&b&&v()},cameraAutoTransform:function(t,e){t.rotation,t.position;p&&!m&&v()}},roomModule:{changeIdProgress:function(){l.root.visible=!1,m=!0},setedDataId:function(t){E=t,m=!1,p&&P(t)},toDoRenderIn:function(){g()},toDoRenderOut:function(){g()}},sdk:{toDoReset:function(t){var e=i.open;i.inLandscape;f=i.type||"spot",h=t.rooms,c=t.roomSpots,u=t.spots,T=t.type,d=l.ProtocolVersion=t.originData.ProtocolVersion,g("3D"===T&&e),l.SIZE_UNIT_TYPE=l.roomConfig.SIZE_UNIT_TYPE||"m"}},sizeTranslateDom:{todoResetSize:function(t){t=t.sizeUnitType;l.SIZE_UNIT_TYPE=void 0===t?"m":t,v(!0)}},ruler:{toDoHide:function(t){e.config.CLICK_CB;p=!t,g()}}});return n.addWithMap(r),g(),{hide:function(t){n.dispatch("toDoHide","ruler",t,"api")}}}}}]);